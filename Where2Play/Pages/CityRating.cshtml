@page
@using Where2Play.Models
@model Where2Play.Pages.CityRatingModel
@{
    ViewData["Title"] = "Tour Planner";
}

<style>
    /* --- EXISTING COLOR SCHEME PRESERVED --- */

    /* Base dark-mode rank styles */
    .top-rank {
        background: linear-gradient(90deg,#163c2b,#1f7a50);
        color: #fff !important;
        font-weight: 700;
        box-shadow: 0 3px 12px rgba(0,0,0,0.35);
    }
    .second-rank {
        background: linear-gradient(90deg,#083449,#215a80);
        color: #fff !important;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }
    .third-rank {
        background: linear-gradient(90deg,#3a1747,#6b2a7f);
        color: #fff !important;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0,0,0,0.22);
    }

    /* Light mode variants (system preference) - remove dark tint/black shade */
    @@media (prefers-color-scheme: light) {
        .top-rank {
            background: linear-gradient(90deg,#fff3bf,#ffd54f) !important;
            color: #212529 !important;
            border: 1px solid #f0c040;
            box-shadow: none !important; /* remove dark tint */
        }
        .second-rank {
            background: linear-gradient(90deg,#d9eefc,#b6dbff) !important;
            color: #04233a !important;
            border: 1px solid #8fb6ea;
            box-shadow: none !important; /* remove dark tint */
        }
        .third-rank {
            background: linear-gradient(90deg,#ffe6f2,#ffb3dd) !important;
            color: #331034 !important;
            border: 1px solid #e69ac8;
            box-shadow: none !important; /* remove dark tint */
        }
        /* Make table header light in light mode */
        .table thead.table-dark { background-color: #f8f9fa !important; color: #212529 !important; }
        /* Remove zebra/tint from striped table rows for ranked items */
        .table.table-striped tbody tr.top-rank,
        .table.table-striped tbody tr.second-rank,
        .table.table-striped tbody tr.third-rank {
            --bs-table-accent-bg: transparent;
            background-color: transparent !important;
        }
    }

    /* Light mode variants (Bootstrap theme attribute) - remove dark tint/black shade */
    [data-bs-theme="light"] .top-rank {
        background: linear-gradient(90deg,#fff3bf,#ffd54f) !important;
        color: #212529 !important;
        border: 1px solid #f0c040;
        box-shadow: none !important;
    }
    [data-bs-theme="light"] .second-rank {
        background: linear-gradient(90deg,#d9eefc,#b6dbff) !important;
        color: #04233a !important;
        border: 1px solid #8fb6ea;
        box-shadow: none !important;
    }
    [data-bs-theme="light"] .third-rank {
        background: linear-gradient(90deg,#ffe6f2,#ffb3dd) !important;
        color: #331034 !important;
        border: 1px solid #e69ac8;
        box-shadow: none !important;
    }
    /* Light theme table header override */
    [data-bs-theme="light"] .table thead.table-dark { background-color: #f8f9fa !important; color: #212529 !important; }
    /* Remove zebra/tint from striped table rows for ranked items */
    [data-bs-theme="light"] .table.table-striped tbody tr.top-rank,
    [data-bs-theme="light"] .table.table-striped tbody tr.second-rank,
    [data-bs-theme="light"] .table.table-striped tbody tr.third-rank {
        --bs-table-accent-bg: transparent;
        background-color: transparent !important;
    }

    .rank-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        text-align: center;
        line-height: 1;
        font-weight: 800;
        font-size: 18px;
        margin-right: 10px;
    }

    .top-rank .rank-badge {
        background: linear-gradient(180deg,#ffd700,#ffb300);
        color: #08130a !important;
        border: 2px solid rgba(0,0,0,0.08);
        box-shadow: 0 4px 14px rgba(255,183,0,0.25), 0 1px 0 rgba(0,0,0,0.12) inset;
    }

    .second-rank .rank-badge {
        background: linear-gradient(180deg,#6ee7ff,#38bdf8);
        color: #012233 !important;
        border: 2px solid rgba(0,0,0,0.06);
        box-shadow: 0 4px 12px rgba(56,189,248,0.18), 0 1px 0 rgba(0,0,0,0.08) inset;
    }

    .third-rank .rank-badge {
        background: linear-gradient(180deg,#ff9fd6,#ff70b8);
        color: #2a022a !important;
        border: 2px solid rgba(0,0,0,0.06);
        box-shadow: 0 4px 12px rgba(255,112,184,0.14), 0 1px 0 rgba(0,0,0,0.06) inset;
    }

    /* Light mode badge variants */
    @@media (prefers-color-scheme: light) {
        .top-rank .rank-badge {
            background: linear-gradient(180deg,#ffd54f,#ffb300);
            color: #212529 !important;
            box-shadow: none !important; /* remove dark glow */
            border-color: rgba(0,0,0,0.06);
        }
        .second-rank .rank-badge {
            background: linear-gradient(180deg,#9fc5ff,#7aa7e6);
            color: #04233a !important;
            box-shadow: none !important;
        }
        .third-rank .rank-badge {
            background: linear-gradient(180deg,#ffd0ea,#ff9fd6);
            color: #331034 !important;
            box-shadow: none !important;
        }
    }
    [data-bs-theme="light"] .top-rank .rank-badge {
        background: linear-gradient(180deg,#ffd54f,#ffb300);
        color: #212529 !important;
        box-shadow: none !important;
        border-color: rgba(0,0,0,0.06);
    }
    [data-bs-theme="light"] .second-rank .rank-badge {
        background: linear-gradient(180deg,#9fc5ff,#7aa7e6);
        color: #04233a !important;
        box-shadow: none !important;
    }
    [data-bs-theme="light"] .third-rank .rank-badge {
        background: linear-gradient(180deg,#ffd0ea,#ff9fd6);
        color: #331034 !important;
        box-shadow: none !important;
    }

    .top-rank .progress-bar, .second-rank .progress-bar, .third-rank .progress-bar {
        opacity: 0.98;
    }

    /* --- NEW TWEAKS --- */

    /* Cleaner input focus state */
    .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        border-color: #86b7fe;
    }

    /* Remove default table success background to prevent clashing */
    .table .table-success {
        background-color: transparent !important;
        color: inherit !important;
    }

    .table-hover tbody tr.table-success:hover {
        background-color: rgba(0,0,0,0.04) !important;
    }

    @@media (prefers-color-scheme: light) {
        .table-hover tbody tr.table-success:hover {
            background-color: rgba(0,0,0,0.02) !important;
        }
    }
    [data-bs-theme="light"] .table-hover tbody tr.table-success:hover {
        background-color: rgba(0,0,0,0.02) !important;
    }

    /* Scope table stripe/hover overrides to City Rating page only to avoid affecting other pages */
    .city-rating-page .table.table-striped tbody tr.top-rank,
    .city-rating-page .table.table-striped tbody tr.second-rank,
    .city-rating-page .table.table-striped tbody tr.third-rank,
    .city-rating-page .table.table-striped tbody tr.table-success {
        --bs-table-accent-bg: transparent;
        background-color: transparent !important;
    }
    .city-rating-page .table-hover tbody tr.top-rank:hover,
    .city-rating-page .table-hover tbody tr.second-rank:hover,
    .city-rating-page .table-hover tbody tr.third-rank:hover,
    .city-rating-page .table-hover tbody tr.table-success:hover {
        background-color: transparent !important;
    }
    /* Light mode: ensure header isn’t dark */
    @@media (prefers-color-scheme: light) {
        .city-rating-page .table thead.table-dark { background-color: #f8f9fa !important; color: #212529 !important; }
    }
    [data-bs-theme="light"] .city-rating-page .table thead.table-dark { background-color: #f8f9fa !important; color: #212529 !important; }
</style>

<div class="container mt-5 city-rating-page">
    <div class="row mb-4">
        <div class="col-md-8 mx-auto text-center">
            <h1 class="display-5 fw-bold">Tour Planner</h1>
            <p class="lead text-muted">Discover the best cities for your next tour based on genre hotspots.</p>
        </div>
    </div>

    <div class="card p-4 mb-5 border-0 shadow-lg rounded-4">
        <!-- Switch to GET to support queryable links & caching hits -->
        <form method="get">
            <div class="row g-4 align-items-end">
                <div class="col-md-4">
                    <label asp-for="BandGenre" class="form-label fw-semibold">Band Genre</label>
                    <input asp-for="BandGenre" class="form-control form-control-lg" placeholder="e.g. Punk, Jazz, Metal" />
                    <span asp-validation-for="BandGenre" class="text-danger small"></span>
                </div>

                <div class="col-md-4">
                    <label asp-for="Popularity" class="form-label fw-semibold">Target Venue Size</label>
                    <select asp-for="Popularity" asp-items="Html.GetEnumSelectList<BandPopularity>()" class="form-select form-select-lg">
                        <option value="">-- Select Size --</option>
                    </select>
                    <span asp-validation-for="Popularity" class="text-danger small"></span>
                </div>

                <div class="col-md-4">
                    <label asp-for="TargetRegion" class="form-label fw-semibold">Target Region</label>
                    <select asp-for="TargetRegion" asp-items="Model.RegionOptions" class="form-select form-select-lg">
                        <option value="">-- Select Region --</option>
                    </select>
                    <span asp-validation-for="TargetRegion" class="text-danger small"></span>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <button type="submit" class="btn btn-primary btn-lg w-100 rounded-pill fw-bold">
                        Look Up Cities
                    </button>
                </div>
            </div>
        </form>
    </div>

    <hr class="my-5 opacity-25" />

    @if (Model.Results != null && Model.Results.Any())
    {
        <div class="row">
            <div class="col-md-12">
                <h3 class="mb-3">Recommended Cities</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col" style="width: 80px;">Rank</th>
                                <th scope="col">City</th>
                                <th scope="col" style="width: 25%;">Fit Score</th>
                                <th scope="col">Why Here?</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int rank = 1;
                            }
                            @foreach (var city in Model.Results)
                            {
                                string rowClass = rank == 1 ? "top-rank" : (rank == 2 ? "second-rank" : (rank == 3 ? "third-rank" : (city.FitScore > 80 ? "table-success" : "")));

                                <tr class="@rowClass">
                                    <td class="text-center">
                                        <span class="rank-badge">@rank</span>
                                    </td>
                                    <td class="fw-bold fs-5">@city.City</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="me-2 fw-bold" style="min-width: 45px;">@city.FitScore%</span>
                                            <div class="progress flex-grow-1 rounded-pill" style="height: 8px; background-color: rgba(255,255,255,0.2);">
                                                <div class="progress-bar rounded-pill @((rank == 1) ? "bg-warning" : (rank == 2 ? "bg-info" : (rank == 3 ? "bg-primary" : "bg-success")))"
                                                     role="progressbar"
                                                     style="width: @city.FitScore%; opacity:0.98;"
                                                     aria-valuenow="@city.FitScore" aria-valuemin="0" aria-valuemax="100">
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>@city.Reason</td>
                                </tr>

                                rank++;
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else if (HttpMethods.IsGet(Request.Method) && !string.IsNullOrWhiteSpace(Model.BandGenre))
    {
        <div class="alert alert-warning mt-4 text-center shadow-sm border-0">
            <strong>No matches found.</strong> Try broadening your search criteria.
        </div>
    }
</div>